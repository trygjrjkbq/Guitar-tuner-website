<?php
    session_start();
    include("database.php");
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Website</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
            
        <h1 id="welcomeHeader">Welcome to our guitar tuner website</h1>
            
        <nav class="navbar">
            <ul>
                <div class="lang" id="lang" onclick="langSwitchCheck()"><img id="langIcon" src="images/LanguagePolish.jpg"></div>
                <li><?php if (!empty($_SESSION['user_id'])): ?>
                        <a id="Log" href="logout.php">Log out</a>
                    <?php else: ?>
                        <a id="Log" href="LogIn.php">Log in!</a>
                    <?php endif; ?>
                </li>
            </ul>
            <ul id = "u2" class="u2">
                <li><a id="Nav1" href="website.html">Home Page</a></li>
                <li><a id="Nav2"href="https://platforma.polsl.pl/rau1/">PZE site</a></li>
                <li><a id="Nav3"href="components.html">Used components</a></li>
                <li><a id="Nav4"href="tutorials.html">Tutorials</a></li>
                <li><a id="Nav5" href="https://lemon.aei.polsl.pl/tiwordpress2025/su52/">Contact Us</a></li>
            </ul>
        </nav>
        <hr>
    </header>

    <main>
        
        <div class="info" id="info">
            <h2>Guitar Tuner</h2>
            <p>Welcome to our guitar tuner website, currently still in development. <br> When finished, this page will house a widget to help with tuning guitars. </p>
        </div>
        <br>

        <div class="notebox">
            <input type="radio" id="enotecheck" name="note"class="buttonstyle">
                <label for="enotecheck">E2</label>
                <input type="radio" id="anotecheck" name="note"class="buttonstyle">
                <label for="anotecheck">A</label>
                <input type="radio" id="dnotecheck" name="note"class="buttonstyle">
                <label for="dnotecheck">D</label>
                <input type="radio" id="gnotecheck" name="note"class="buttonstyle">
                <label for="gnotecheck">G</label>
                <input type="radio" id="bnotecheck" name="note"class="buttonstyle">
                <label for="bnotecheck">B</label>
                <input type="radio" id="ehighnotecheck" name="note" class="buttonstyle">
                <label for="ehighnotecheck">E4</label><br><br>

                <button type="play" id="soundtest" class="buttonstyleplay">Play sound</button><br><br>
                <p id="soundresponse"></p><br>
        </div>

<div id="detector" class="confident tuner-container">

    <button class="tunerToggle" onclick="toggleLiveInput()">Start</button><br>
    <div class="slidecontainer">
        <input type="range" min="1" max="10" value="3" class="slider" id="slider">
        <p><div id="sliderLabel">Value: </div><span id="sliderValue">4096</span></p>
        <button onclick="updateBufferSize()" class="bufferSizeSet" id="sampleBufferButton">Set sample buffer size</button>
    </div>


<div class="tuner-left">
    <div class="freq" id="freqDisplay">-- Hz</div>
    <div class="note bignote"><span id="note">-</span></div>
    <div class="noteMatch"><span id="noteClosestNote">Closest guitar note: </span><span id="noteMatch">--</span></div>
    <div class="cents"><span id="noteOffsetCentLabel">Offset: </span><span id="detune_amt">--</span> cent</div>
    <div class="noteOffset"><span id="noteOffsetLabel">Offset from note by: </span><span id="noteOffset">--</span> Hz.</div><br>
    <div class="controls">
        <div id="colorBox" class="color-box" title="Jak blisko jesteś"></div>
    </div>
</div>

  <!-- Prawa kolumna: tarcza z igłą i pasek nut -->
  <div class="tuner-right">
    <div id="meter" class="meter">
      <!-- igła -->
      <div id="needle" class="needle">
        <div class="pivot"></div>
      </div>
      <!-- miejsca na kropki łuku (wygenerujemy je JS-em) -->
    </div>


  <canvas id="output" width="400" height="42" style="margin-top:12px;"></canvas>
</div>
</div>

<?php
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['comment_text'])) {
    if (!empty($_SESSION['user_id'])) {
        $text = trim($_POST['comment_text']);
        if ($text !== '') {
            $stmt = $conn->prepare("INSERT INTO comments (user_id, content) VALUES (?, ?)");
            $uid = $_SESSION['user_id'];
            $stmt->bind_param("is", $uid, $text);
            $stmt->execute();
            $stmt->close();
            header("Location: " . $_SERVER['PHP_SELF']); // odświeżenie
            exit;
        }
    } else {
        $comment_feedback = "You need to be logged in to write comments.";
    }
}

$comments = [];
$res = $conn->query("SELECT c.content, c.created_at, u.username FROM comments c JOIN users u ON c.user_id = u.id ORDER BY c.created_at DESC");
while ($row = $res->fetch_assoc()) $comments[] = $row;
?>
<div id="comments">
  <h3>Comments</h3>
  <?php if(!empty($_SESSION['user_id'])): ?>
    <form method="post" action="<?php echo $_SERVER['PHP_SELF']; ?>">
      <textarea name="comment_text" rows="3" cols="40"></textarea><br>
      <button type="submit">Write a comment</button>
    </form>
  <?php else: ?>
    <p><a href="LogIn.php?return=<?php echo urlencode($_SERVER['PHP_SELF']); ?>">Log in</a> to write a comment.</p>
  <?php endif; ?>
  <p><?php echo $comment_feedback ?? ''; ?></p>

  <ul>
    <?php foreach ($comments as $c): ?>
      <li><strong><?php echo htmlspecialchars($c['username']); ?></strong> (<?php echo $c['created_at']; ?>):<br>
          <?php echo nl2br(htmlspecialchars($c['content'])); ?></li>
    <?php endforeach; ?>
  </ul>

    <script src="language.js"></script>
    <script src="langpolish.js"></script>
    <script src="index.js"></script>
    </main>
    <br>
    <footer style="background-color: rgb(95, 8, 8)">
        <hr>
        Authors: Filip Duda and Jakub Garus</br>
        &copy; 2025 copyright reserved<br>
        <small><a href="mailto:Ja@fake.com">Ja@fake.com</a>
    </footer>
</body>
</html>